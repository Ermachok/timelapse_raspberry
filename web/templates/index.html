<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timelapse Controller</title>
    <style>
        body { font-family: sans-serif; display: flex; gap: 20px; padding: 20px; }
        .controls { display: flex; flex-direction: column; gap: 10px; }
        .indicator { font-weight: bold; }
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <div class="controls">
        <button onclick="startTimelapse()">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Ç–∞–π–º–ª–∞–ø—Å</button>
        <button onclick="showStopModal()">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–ª–∞–ø—Å</button>
        <button id="downloadBtn" onclick="downloadVideo()" style="display: none;">üì• –°–∫–∞—á–∞—Ç—å —Ç–∞–π–º–ª–∞–ø—Å</button>
        <div class="indicator">–°—Ç–∞—Ç—É—Å: <span id="status-indicator">üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span></div>
    </div>

    <div>
        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–Ω–∏–º–æ–∫</h3>
        <img id="latest-photo" src="" width="480" height="360" />
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
    <div class="modal" id="stop-modal">
        <div class="modal-content">
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–ª–∞–ø—Å?</p>
            <button onclick="confirmStop()">–î–∞, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        let intervalId = null;

        function startTimelapse() {
            fetch("/start_timelapse", { method: "POST" })
                .then(() => {
                    document.getElementById("status-indicator").textContent = "üü¢ –ò–¥—ë—Ç —Å—ä—ë–º–∫–∞";
                    document.getElementById("downloadBtn").style.display = "none";
                    intervalId = setInterval(updatePhoto, 3000);
                });
        }

        function showStopModal() {
            document.getElementById("stop-modal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("stop-modal").style.display = "none";
        }

        function confirmStop() {
            closeModal();
            fetch("/stop_timelapse", { method: "POST" })
                .then(() => {
                    document.getElementById("status-indicator").textContent = "üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
                    clearInterval(intervalId);
                    setTimeout(() => {
                        document.getElementById("downloadBtn").style.display = "block";
                        updatePhoto();  // –û–±–Ω–æ–≤–∏–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Ñ–æ—Ç–æ
                    }, 2000); // –ñ–¥—ë–º –ø–æ–∫–∞ –≤–∏–¥–µ–æ —Å–æ–±–µ—Ä—ë—Ç—Å—è
                });
        }

        function updatePhoto() {
            const img = document.getElementById("latest-photo");
            img.src = "/latest_photo?" + new Date().getTime(); // –∫–µ—à-–±–∞—Å—Ç–µ—Ä
        }

        function downloadVideo() {
            window.open("/timelapse_video", "_blank");
        }
    </script>
</body>
</html>
